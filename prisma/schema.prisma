// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String             @id @default(uuid())
  email              String             @unique
  password           String
  name               String
  role               Role               @default(USER)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  deathRegistrations DeathRegistration[]
  burialPermits      BurialPermit[]
  exhumationPermits  ExhumationPermit[]
  cremationPermits   CremationPermit[]
  deathCertificateRequests DeathCertificateRequest[]
  auditLogs          AuditLog[]
  transactions       Transaction[]
}

enum Role {
  USER
  EMPLOYEE
  ADMIN
}

model ApiKey {
  id          String   @id @default(uuid())
  name        String   // Descriptive name for the API key
  key         String   @unique
  isActive    Boolean  @default(true)
  createdBy   String   // Admin who created it
  createdAt   DateTime @default(now())
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  
  @@index([key])
}

model DeathRegistration {
  id                    String                    @id @default(uuid())
  userId                String
  user                  User                      @relation(fields: [userId], references: [id])
  
  // Registration Type
  registrationType      RegistrationType          @default(REGULAR)
  registrationFee       Float                     @default(50.00)
  
  // Deceased Details
  deceasedFirstName     String
  deceasedMiddleName    String?
  deceasedLastName      String
  deceasedDateOfBirth   DateTime
  deceasedDateOfDeath   DateTime
  deceasedPlaceOfDeath  String
  deceasedCauseOfDeath  String
  deceasedGender        String
  
  // Informant Details
  informantName         String
  informantRelation     String
  informantContactNumber String
  informantAddress      String
  
  // Document Uploads (file paths)
  municipalForm103      String  // Death Certificate Form
  informantValidId      String
  swabTestResult        String? // Optional, only if Covid-related
  
  // Delayed Registration Documents
  affidavitOfDelayed    String? // For delayed registration
  burialCertificate     String? // For delayed registration
  funeralCertificate    String? // For delayed registration
  psaNoRecord           String? // PSA Certificate of No Record
  
  // Payment Details
  orderOfPayment        String? // Generated OR number
  proofOfPayment        String? // Uploaded proof
  paymentConfirmed      Boolean                   @default(false)
  paymentStatus         String?                   @default("PENDING") // PENDING, PAID, FAILED
  
  // Status and Processing
  status                DeathRegistrationStatus   @default(PENDING_VERIFICATION)
  remarks               String?
  processedBy           String? // Employee ID who processed
  processedAt           DateTime?
  processingDeadline    DateTime? // For delayed: 11 working days from payment
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([registrationType])
  @@index([paymentStatus])
}

enum RegistrationType {
  REGULAR
  DELAYED
}

enum DeathRegistrationStatus {
  PENDING_VERIFICATION
  RETURNED_FOR_CORRECTION
  APPROVED_FOR_PAYMENT
  PAYMENT_SUBMITTED
  PAYMENT_CONFIRMED
  REGISTERED_FOR_PICKUP
  COMPLETED
  REJECTED
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String   // e.g., "DEATH_REGISTRATION_SUBMITTED", "DEATH_REGISTRATION_APPROVED"
  entityType  String   // e.g., "DeathRegistration", "User"
  entityId    String?  // ID of the affected entity
  details     String?  // JSON string with additional details
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

model Transaction {
  id                String   @id @default(uuid())
  userId            String   // Citizen who paid
  user              User     @relation(fields: [userId], references: [id])
  transactionType   String   // e.g., "DEATH_REGISTRATION_FEE"
  amount            Float
  orderOfPayment    String   // OR number
  paymentMethod     String?  // e.g., "CASH", "ONLINE", "GCASH"
  referenceNumber   String?  // Reference from payment proof
  status            TransactionStatus @default(CONFIRMED)
  confirmedBy       String?  // Employee who confirmed
  confirmedAt       DateTime @default(now())
  entityType        String   // e.g., "DeathRegistration"
  entityId          String   // ID of related entity
  remarks           String?
  createdAt         DateTime @default(now())
  
  @@index([userId])
  @@index([status])
  @@index([transactionType])
  @@index([createdAt])
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

model BurialPermit {
  id                    String                @id @default(uuid())
  userId                String
  user                  User                  @relation(fields: [userId], references: [id])
  
  // Deceased Information
  deceasedName          String
  deceasedDateOfDeath   DateTime
  
  // Requester Information
  requesterName         String
  requesterRelation     String
  requesterContactNumber String
  requesterAddress      String
  
  // Burial Details
  burialType            BurialType            @default(BURIAL)
  nicheType             NicheType?            // Only for niche/columbarium
  cemeteryLocation      String?               // Bagbag, Novaliches, or other
  isFromAnotherLGU      Boolean               @default(false)
  
  // Document Uploads
  deathCertificate      String                // Path to death certificate
  transferPermit        String?               // If from another LGU
  affidavitOfUndertaking String?              // If Bagbag/Novaliches
  burialForm            String                // QCHD form
  validId               String                // Requester's ID
  
  // Payment and Processing
  orderOfPayment        String?
  permitFee             Float                 @default(100.00)
  nicheFee              Float?                // For niche: 750 (child) or 1500 (adult)
  totalFee              Float                 @default(100.00)
  proofOfPayment        String?
  paymentConfirmed      Boolean               @default(false)
  paymentStatus         String?               @default("PENDING") // PENDING, PAID, FAILED
  
  // Status and Processing
  status                BurialPermitStatus    @default(PENDING_VERIFICATION)
  remarks               String?
  processedBy           String?
  processedAt           DateTime?
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([burialType])
  @@index([paymentStatus])
}

enum BurialType {
  BURIAL           // Regular burial - ₱100
  ENTRANCE         // Entrance permit - ₱100  
  NICHE            // Niche/Columbarium - ₱100 + niche fee
}

enum NicheType {
  CHILD            // ₱750
  ADULT            // ₱1500
}

enum BurialPermitStatus {
  PENDING_VERIFICATION
  RETURNED_FOR_CORRECTION
  APPROVED_FOR_PAYMENT
  PAYMENT_SUBMITTED
  REGISTERED_FOR_PICKUP
  COMPLETED
  REJECTED
}
model DeathCertificateRequest {
  id                    String                         @id @default(uuid())
  userId                String
  user                  User                           @relation(fields: [userId], references: [id])
  
  // Deceased Information
  deceasedFullName      String
  deceasedDateOfDeath   DateTime
  deceasedPlaceOfDeath  String
  
  // Requester Information
  requesterName         String
  requesterRelation     String
  requesterContactNumber String
  requesterAddress      String
  purpose               String                         // Purpose of request
  
  // Certificate Details
  numberOfCopies        Int                            @default(1)
  pickupMethod          String                         @default("PICKUP_ONLY")  // Always pickup only
  
  // Document Uploads
  validId               String                         // Requester's ID
  authorizationLetter   String?                        // If not next of kin
  
  // Payment and Processing
  orderOfPayment        String?
  certificateFee        Float                          // ₱50 for first copy
  additionalCopiesFee   Float                          @default(0)  // ₱50 per additional copy
  totalFee              Float                          // Total amount
  submittedOrderNumber  String?                        // OR number submitted by user
  paymentProof          String?                        // Path to payment proof document
  paymentSubmittedAt    DateTime?
  paymentVerifiedBy     String?                        // Employee who verified payment
  paymentVerifiedAt     DateTime?
  paymentStatus         String?                        @default("PENDING") // PENDING, PAID, FAILED
  
  // Verification
  verifiedBy            String?                        // Employee who verified the request
  verifiedAt            DateTime?
  verificationNotes     String?
  
  // Certificate Processing
  certificatePrintedBy  String?                        // Employee who printed certificate
  certificatePrintedAt  DateTime?
  claimSchedule         String?                        // Scheduled date for pickup
  
  // Status and Processing
  status                DeathCertificateRequestStatus  @default(PENDING_VERIFICATION)
  remarks               String?
  processedBy           String?
  processedAt           DateTime?
  
  createdAt             DateTime                       @default(now())
  updatedAt             DateTime                       @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
}

enum DeathCertificateRequestStatus {
  PENDING_VERIFICATION
  RETURNED_FOR_CORRECTION
  APPROVED_FOR_PAYMENT
  PAYMENT_SUBMITTED
  REGISTERED_FOR_PICKUP
  COMPLETED
  REJECTED
}
model ExhumationPermit {
  id                    String                    @id @default(uuid())
  userId                String
  user                  User                      @relation(fields: [userId], references: [id])
  
  // Deceased Information
  deceasedName          String
  deceasedDateOfDeath   DateTime
  deceasedDateOfBurial  DateTime
  deceasedPlaceOfBurial String
  
  // Requester Information
  requesterName         String
  requesterRelation     String
  requesterContactNumber String
  requesterAddress      String
  reasonForExhumation   String
  
  // Document Uploads
  exhumationLetter      String                    // QC Health Dept letter
  deathCertificate      String                    // Certified death certificate
  validId               String                    // Requester's ID
  
  // Payment and Processing
  orderOfPayment        String?
  permitFee             Float                     @default(100.00)
  proofOfPayment        String?
  paymentConfirmed      Boolean                   @default(false)
  paymentStatus         String?                   @default("PENDING") // PENDING, PAID, FAILED
  
  // Status and Processing
  status                ExhumationPermitStatus    @default(PENDING_VERIFICATION)
  remarks               String?
  processedBy           String?
  processedAt           DateTime?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
}

enum ExhumationPermitStatus {
  PENDING_VERIFICATION
  RETURNED_FOR_CORRECTION
  APPROVED_FOR_PAYMENT
  PAYMENT_SUBMITTED
  REGISTERED_FOR_PICKUP
  COMPLETED
  REJECTED
}
model CremationPermit {
  id                    String                    @id @default(uuid())
  userId                String
  user                  User                      @relation(fields: [userId], references: [id])
  
  // Deceased Information
  deceasedName          String
  deceasedDateOfDeath   DateTime
  
  // Requester Information
  requesterName         String
  requesterRelation     String
  requesterContactNumber String
  requesterAddress      String
  
  // Funeral Home (optional)
  funeralHomeName       String?
  funeralHomeContact    String?
  
  // Document Uploads
  deathCertificate      String                    // Path to death certificate
  cremationForm         String                    // QCHD cremation form
  transferPermit        String?                   // If from another location
  validId               String                    // Requester's ID
  
  // Payment and Processing
  orderOfPayment        String?
  permitFee             Float                     @default(100.00)
  submittedOrderNumber  String?                   // OR number submitted by user
  paymentProof          String?                   // Path to payment proof document
  paymentSubmittedAt    DateTime?
  paymentVerifiedBy     String?                   // Employee who verified payment
  paymentVerifiedAt     DateTime?
  paymentStatus         String?                   @default("PENDING") // PENDING, PAID, FAILED
  
  // Verification
  verifiedBy            String?                   // Employee who verified the documents
  verifiedAt            DateTime?
  verificationNotes     String?
  
  // Status and Processing
  status                CremationPermitStatus     @default(PENDING_VERIFICATION)
  remarks               String?
  processedBy           String?
  processedAt           DateTime?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
}

enum CremationPermitStatus {
  PENDING_VERIFICATION
  RETURNED_FOR_CORRECTION
  APPROVED_FOR_PAYMENT
  PAYMENT_SUBMITTED
  REGISTERED_FOR_PICKUP
  COMPLETED
  REJECTED
}

model Event {
  id          String   @id @default(uuid())
  title       String
  description String
  eventDate   DateTime
  location    String
  category    EventCategory @default(OTHER)
  createdBy   String   // Employee/Admin who created the event
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([eventDate])
  @@index([category])
}

enum EventCategory {
  MEMORIAL
  ALL_SOULS
  UNDAS
  MAINTENANCE
  OTHER
}
